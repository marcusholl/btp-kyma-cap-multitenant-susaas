---
general:
  buildTool: "npm"
  chartPath: charts/sustainable-saas
  verbose: true
service:
  buildToolVersion: "N18"
stages:
  Build:
    mavenExecuteStaticCodeChecks: false
    npmExecuteLint: false
  Additional Unit Tests:
    npmExecuteScripts: false
  Acceptance:
    npmExecuteEndToEndTests: false
    kubernetesDeploy: false
    # this is where the configuration would go for a kubernetesDeploy during the Acceptance stage
#    containerRegistrySecret: concise
#    additionalParameters:
#      - --debug
#    deploymentName: mh-deployment-01
#    kubeConfigFileCredentialsId: kube-config
#    namespace: mh-01
#    valuesMapping:
#      global.imagePullSecret.name: imagePullSecrets[0].name
  Compliance:
    sonarExecuteScan: false
  Release:
    kubernetesDeploy: true
    containerRegistrySecret: concise
    additionalParameters:
      # we should keep the debug flag. Otherwise there is not much written to the log during deployment. That look like we are stuck.
      - --debug
    deploymentName: mh-deployment-01
    kubeConfigFileCredentialsId: kube-config
    namespace: mh-01
    valuesMapping:
      global.imagePullSecret.name: imagePullSecrets[0].name # imagePullSecrets[0].name is defined by Piper

steps:
  # custom additions to make npm build work
  buildExecute:
    npmRunScripts: [ 'cds-build' ]
    npmInstall: false
    cnbBuild: true
    helmExecute: true

  cnbBuild:
    containerRegistryUrl: https://concise.common.repositories.cloud.sap
    dockerConfigJsonCredentialsId: docker-config
    multipleImages:
      - path: gen/srv
        containerImageName: susaas.image/susaas.srv
        containerImageAlias: susaas_image/susaas_srv
      - path: gen/api
        containerImageName: susaas.image/susaas.api
        containerImageAlias: susaas_image/susaas_api
      - path: broker
        containerImageName: susaas.image/broker
        containerImageAlias: susaas_image/broker
      - path: gen/db-com
        containerImageName: susaas.image/susaas.db.com
        containerImageAlias: susaas_image/susaas_db_com
    # containerImageTag is optional. When not provided, this means a guid prepared by artifactSetVersion will be used

  helmExecute:
    helmCommand: dependency
    dependency: update
    templateStartDelimiter: '[['
    templateEndDelimiter: ']]'
    chartPath: charts/sustainable-saas

  kubernetesDeploy:
    chartPath: charts/sustainable-saas
    valuesMapping:
      api.image.repository: image.susaas_image/susaas_api.repository
      api.image.tag: image.susaas_image/susaas_api.tag
      srv.image.repository: image.susaas_image/susaas_srv.repository
      srv.image.tag: image.susaas-image/susaas-srv.tag
      broker.image.repository: image.susaas_image/broker.repository
      broker.image.tag: image.susaas_image/broker.tag

  dockerExecuteOnKubernetes:
    # should be removed for final version
    verbose: true
